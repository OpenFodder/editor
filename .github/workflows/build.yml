name: build

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  windows:
    runs-on: windows-2022
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Cache vcpkg
        uses: actions/cache@v4
        with:
          path: |
            vcpkg_installed
            Project/third_party/vcpkg
            Project/third_party/vcpkg/downloads
            Project/third_party/vcpkg/archives
          key: vcpkg-${{ runner.os }}-${{ hashFiles('vcpkg.json') }}

      - name: Build (Release x64)
        shell: pwsh
        run: |
          if (Test-Path Run) { Remove-Item Run -Recurse -Force }
          .\Project\build_vs.cmd x64 Release

      - name: List Run contents
        shell: pwsh
        run: |
          Get-ChildItem -Path Run -File | Format-Table Name, Length

      - name: Package build
        shell: pwsh
        run: |
          $zipName = "OpenFodderEditor-x64-Release-latest.zip"
          if (Test-Path $zipName) { Remove-Item $zipName -Force }
          Compress-Archive -Path Run\* -DestinationPath $zipName
          Write-Output "ZIP_NAME=$zipName" | Out-File -FilePath $env:GITHUB_ENV -Append

      - name: Upload Run artifacts
        uses: actions/upload-artifact@v4
        with:
          name: editor-run
          path: Run/*

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION || 'us-east-1' }}

      - name: Upload build zip to S3
        shell: pwsh
        run: |
          aws s3 cp "$env:ZIP_NAME" "s3://openfodder-builds/$env:ZIP_NAME" --acl public-read

      - name: Discord notification
        if: always() && env.DISCORD_WEBHOOK_URL != ''
        shell: pwsh
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          $status = if ("${{ job.status }}" -eq "success") { "Success" } else { "Failure" }
          $color = if ("${{ job.status }}" -eq "success") { 3066993 } else { 15158332 }
          $title = "Editor (Windows) build $status (x64)"
          $runUrl = "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          $downloadUrl = "https://s3.amazonaws.com/openfodder-builds/$env:ZIP_NAME"
          $payload = @{
            username = "GitHub Actions"
            embeds = @(
              @{
                title = $title
                url = $runUrl
                color = $color
                fields = @(
                  @{ name = "Commit"; value = "${{ github.sha }}"; inline = $true }
                  @{ name = "Message"; value = "${{ github.event.head_commit.message || github.event.pull_request.title }}"; inline = $false }
                  @{ name = "Branch"; value = "${{ github.ref_name }}"; inline = $true }
                  @{ name = "Config"; value = "Release"; inline = $true }
                  @{ name = "Download"; value = $downloadUrl; inline = $false }
                )
              }
            )
          } | ConvertTo-Json -Depth 5

          Invoke-RestMethod -Method Post -Uri $env:DISCORD_WEBHOOK_URL -ContentType "application/json" -Body $payload
